name: Delete branch environment

on:
  delete:

jobs:
  delete-namespace:
    runs-on: ubuntu-latest

    steps:
      - name: Debug delete event
        run: |
          echo "ref_name: ${{ github.ref_name }}"
          echo "event.ref: ${{ github.event.ref }}"
          echo "event.ref_type: ${{ github.event.ref_type }}"

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GKE_SA_KEY }}"
          export_default_credentials: true

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GKE_PROJECT }}
          service_account_key: "${{ secrets.GKE_SA_KEY }}"
          export_default_credentials: true

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: kube-mooc
          project_id: ${{ secrets.GKE_PROJECT }}
          location: asia-southeast2

      - name: Delete namespace
        run: |
          # Only act on branch deletion
          if [ "${{ github.event.ref_type }}" != "branch" ]; then
            echo "Not a branch deletion, skipping"
            exit 0
          fi

          DELETED_BRANCH="${{ github.event.ref }}"

          # Protect default branch
          if [ "$DELETED_BRANCH" = "master" ]; then
            echo "Skipping deletion of master/project namespace"
            exit 0
          fi

          echo "Deleting namespace: $DELETED_BRANCH"
          kubectl delete namespace "$DELETED_BRANCH" || echo "Namespace not found"
